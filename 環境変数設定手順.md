# 環境変数設定の完全ガイド

このガイドに従って、すべての環境変数を設定してください。

## ステップ1: Supabaseプロジェクトの作成と設定

### 1-1. アカウント作成とプロジェクト作成

1. **Supabaseにアクセス**
   - https://supabase.com/ にアクセス
   - 「Start your project」をクリック
   - GitHubアカウントでサインアップ（推奨）

2. **新規プロジェクトを作成**
   - 「New Project」をクリック
   - プロジェクト名を入力（例: `event-platform`）
   - データベースパスワードを設定（**必ず保存してください**）
   - リージョンを選択（`Northeast Asia (Tokyo)`推奨）
   - 「Create new project」をクリック
   - プロジェクトの準備完了まで1-2分待つ

### 1-2. Supabase APIキーの取得

1. **Settings > API**に移動
   - 左サイドバーの「Settings」（歯車アイコン）をクリック
   - 「API」をクリック

2. **必要な情報をコピー**
   - **Project URL**: `https://xxxxxxxxxxxxx.supabase.co`
   - **anon public key**: `eyJhbGciOiJIUzI1...` （長い文字列）

   この2つを**メモ帳にコピー**してください。

### 1-3. データベースのセットアップ

1. **SQL Editorを開く**
   - 左サイドバーの「SQL Editor」をクリック
   - 「New query」をクリック

2. **以下のSQLを実行**（順番に1つずつ実行）

#### テーブル1: organizers（主催者）

```sql
CREATE TABLE organizers (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  organization_name TEXT NOT NULL,
  email TEXT NOT NULL,
  phone_number TEXT NOT NULL,
  is_approved BOOLEAN DEFAULT false,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- RLSポリシー
ALTER TABLE organizers ENABLE ROW LEVEL SECURITY;

CREATE POLICY "organizers_select_own" ON organizers
  FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "organizers_insert_own" ON organizers
  FOR INSERT WITH CHECK (auth.uid() = user_id);

CREATE POLICY "organizers_update_own" ON organizers
  FOR UPDATE USING (auth.uid() = user_id);
```

**実行方法**: SQLをコピー → 貼り付け → 「Run」をクリック

#### テーブル2: exhibitors（出店者）

```sql
CREATE TABLE exhibitors (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  gender TEXT,
  age INTEGER,
  email TEXT NOT NULL,
  phone_number TEXT NOT NULL,
  postal_code TEXT,
  prefecture TEXT,
  city TEXT,
  address_line TEXT,
  genre_category TEXT,
  sales_items TEXT,
  business_license_url TEXT,
  vehicle_inspection_url TEXT,
  liability_insurance_url TEXT,
  pl_insurance_url TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- RLSポリシー
ALTER TABLE exhibitors ENABLE ROW LEVEL SECURITY;

CREATE POLICY "exhibitors_select_own" ON exhibitors
  FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "exhibitors_insert_own" ON exhibitors
  FOR INSERT WITH CHECK (auth.uid() = user_id);

CREATE POLICY "exhibitors_update_own" ON exhibitors
  FOR UPDATE USING (auth.uid() = user_id);
```

#### テーブル3: events（イベント）

```sql
CREATE TABLE events (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organizer_id UUID REFERENCES organizers(id) ON DELETE CASCADE,
  event_name TEXT NOT NULL,
  event_start_date DATE NOT NULL,
  event_end_date DATE NOT NULL,
  venue_name TEXT NOT NULL,
  venue_address TEXT NOT NULL,
  venue_access TEXT,
  event_description TEXT,
  recruitment_count INTEGER,
  participation_fee INTEGER,
  booth_size TEXT,
  power_supply_available BOOLEAN DEFAULT false,
  water_supply_available BOOLEAN DEFAULT false,
  parking_available BOOLEAN DEFAULT false,
  tent_required BOOLEAN DEFAULT false,
  main_image_url TEXT,
  approval_status TEXT DEFAULT 'pending',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- RLSポリシー
ALTER TABLE events ENABLE ROW LEVEL SECURITY;

CREATE POLICY "events_select_all" ON events
  FOR SELECT USING (true);

CREATE POLICY "events_insert_own" ON events
  FOR INSERT WITH CHECK (
    EXISTS (
      SELECT 1 FROM organizers
      WHERE organizers.id = events.organizer_id
      AND organizers.user_id = auth.uid()
    )
  );

CREATE POLICY "events_update_own" ON events
  FOR UPDATE USING (
    EXISTS (
      SELECT 1 FROM organizers
      WHERE organizers.id = events.organizer_id
      AND organizers.user_id = auth.uid()
    )
  );

CREATE POLICY "events_delete_own" ON events
  FOR DELETE USING (
    EXISTS (
      SELECT 1 FROM organizers
      WHERE organizers.id = events.organizer_id
      AND organizers.user_id = auth.uid()
    )
  );
```

#### テーブル4: event_applications（申し込み）

```sql
CREATE TABLE event_applications (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  event_id UUID REFERENCES events(id) ON DELETE CASCADE,
  exhibitor_id UUID REFERENCES exhibitors(id) ON DELETE CASCADE,
  application_status TEXT DEFAULT 'pending',
  applied_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  reviewed_at TIMESTAMP WITH TIME ZONE
);

-- RLSポリシー
ALTER TABLE event_applications ENABLE ROW LEVEL SECURITY;

CREATE POLICY "applications_select_own_exhibitor" ON event_applications
  FOR SELECT USING (
    EXISTS (
      SELECT 1 FROM exhibitors
      WHERE exhibitors.id = event_applications.exhibitor_id
      AND exhibitors.user_id = auth.uid()
    )
  );

CREATE POLICY "applications_select_own_organizer" ON event_applications
  FOR SELECT USING (
    EXISTS (
      SELECT 1 FROM events e
      JOIN organizers o ON o.id = e.organizer_id
      WHERE e.id = event_applications.event_id
      AND o.user_id = auth.uid()
    )
  );

CREATE POLICY "applications_insert_own" ON event_applications
  FOR INSERT WITH CHECK (
    EXISTS (
      SELECT 1 FROM exhibitors
      WHERE exhibitors.id = event_applications.exhibitor_id
      AND exhibitors.user_id = auth.uid()
    )
  );

CREATE POLICY "applications_update_organizer" ON event_applications
  FOR UPDATE USING (
    EXISTS (
      SELECT 1 FROM events e
      JOIN organizers o ON o.id = e.organizer_id
      WHERE e.id = event_applications.event_id
      AND o.user_id = auth.uid()
    )
  );
```

#### テーブル5: notifications（通知）

```sql
CREATE TABLE notifications (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  user_type TEXT NOT NULL,
  title TEXT NOT NULL,
  message TEXT NOT NULL,
  is_read BOOLEAN DEFAULT false,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- RLSポリシー
ALTER TABLE notifications ENABLE ROW LEVEL SECURITY;

CREATE POLICY "notifications_select_own" ON notifications
  FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "notifications_update_own" ON notifications
  FOR UPDATE USING (auth.uid() = user_id);
```

### 1-4. Storageの設定

1. **Storageセクションを開く**
   - 左サイドバーの「Storage」をクリック
   - 「Create a new bucket」をクリック

2. **documentsバケットを作成**
   - Name: `documents`
   - Public bucket: **チェックしない**（プライベート）
   - 「Create bucket」をクリック

3. **imagesバケットを作成**
   - Name: `images`
   - Public bucket: **チェックする**（パブリック）
   - 「Create bucket」をクリック

4. **documentsバケットのポリシーを設定**
   - `documents`バケットをクリック
   - 「Policies」タブをクリック
   - 「New policy」をクリック
   - 以下のポリシーを追加:

```sql
-- アップロードポリシー
CREATE POLICY "Users can upload own documents"
ON storage.objects FOR INSERT
WITH CHECK (
  bucket_id = 'documents' AND
  auth.uid()::text = (storage.foldername(name))[1]
);

-- 閲覧ポリシー
CREATE POLICY "Users can view own documents"
ON storage.objects FOR SELECT
USING (
  bucket_id = 'documents' AND
  auth.uid()::text = (storage.foldername(name))[1]
);
```

---

## ステップ2: LINE Loginの設定（オプション）

### 2-1. LINE Developersコンソールにアクセス

1. https://developers.line.biz/console/ にアクセス
2. LINEアカウントでログイン

### 2-2. プロバイダーとチャネルを作成

1. **プロバイダーを作成**（初回のみ）
   - 「Create」をクリック
   - プロバイダー名を入力（例: `EventPlatform`）
   - 「Create」をクリック

2. **チャネルを作成**
   - 「Create a LINE Login channel」をクリック
   - チャネル名: `Event Platform Store`（出店者用）
   - チャネル説明: `イベントプラットフォーム 出店者向けアプリ`
   - App types: 「Web app」にチェック
   - Email address: あなたのメールアドレス
   - Privacy policy URL: （後で設定可能）
   - Terms of use URL: （後で設定可能）
   - 「Create」をクリック

3. **同様に主催者用チャネルも作成**
   - チャネル名: `Event Platform Organizer`（主催者用）

### 2-3. Channel IDとCallback URLを設定

**出店者用（store/）の設定:**

1. 作成したチャネルをクリック
2. 「Basic settings」タブ
   - **Channel ID**をコピー → メモ帳に保存
3. 「LINE Login」タブ
   - Callback URL: `http://localhost:3001/auth/callback` を追加
   - 「Update」をクリック

**主催者用（organizer/）の設定:**

1. 同様に設定
2. Callback URL: `http://localhost:3002/auth/callback`

---

## ステップ3: OpenAI API Keyの取得（オプション - 画像認識機能用）

### 3-1. OpenAI Platformにアクセス

1. https://platform.openai.com/ にアクセス
2. アカウントを作成（またはログイン）

### 3-2. API Keyを作成

1. 左サイドバーの「API keys」をクリック
2. 「Create new secret key」をクリック
3. 名前を入力（例: `event-platform-ocr`）
4. 「Create secret key」をクリック
5. **API Keyをコピー**（この画面でしか表示されません！）→ メモ帳に保存

### 3-3. 料金設定

- OpenAI Platformの「Settings」→「Billing」で支払い方法を設定
- 画像認識は1回あたり約$0.01-0.02

---

## ステップ4: 環境変数ファイルの作成

### 4-1. store/.env.local の作成

ターミナルで以下を実行:

```bash
cd /Users/mocky700/Desktop/デミセル/store
touch .env.local
```

エディタで開いて、以下を記入（メモ帳の内容を使用）:

```env
# Supabase設定
NEXT_PUBLIC_SUPABASE_URL=https://xxxxxxxxxxxxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3...（長い文字列）

# LINE Login設定
NEXT_PUBLIC_LINE_LOGIN_CHANNEL_ID=1234567890
NEXT_PUBLIC_LINE_LOGIN_REDIRECT_URI=http://localhost:3001/auth/callback

# OpenAI API設定（オプション）
OPENAI_API_KEY=sk-proj-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

### 4-2. organizer/.env.local の作成

```bash
cd /Users/mocky700/Desktop/デミセル/organizer
touch .env.local
```

エディタで開いて、以下を記入:

```env
# Supabase設定
NEXT_PUBLIC_SUPABASE_URL=https://xxxxxxxxxxxxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3...（長い文字列）

# LINE Login設定
NEXT_PUBLIC_LINE_LOGIN_CHANNEL_ID=9876543210
NEXT_PUBLIC_LINE_LOGIN_REDIRECT_URI=http://localhost:3002/auth/callback
```

### 4-3. admin/.env.local の作成

```bash
cd /Users/mocky700/Desktop/デミセル/admin
touch .env.local
```

エディタで開いて、以下を記入:

```env
# Supabase設定
NEXT_PUBLIC_SUPABASE_URL=https://xxxxxxxxxxxxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3...（長い文字列）

# 管理者メールアドレス（カンマ区切り）
NEXT_PUBLIC_ADMIN_EMAILS=admin@example.com,youremail@example.com
```

**注意**: `NEXT_PUBLIC_ADMIN_EMAILS`には、実際に管理者としてログインするメールアドレスを設定してください。

---

## ステップ5: 管理者ユーザーの作成（admin用）

### 5-1. Supabaseで管理者ユーザーを作成

1. Supabaseダッシュボードの「Authentication」→「Users」をクリック
2. 「Add user」→「Create new user」をクリック
3. メールアドレスとパスワードを入力
   - Email: `admin@example.com`（admin/.env.localに設定したメールアドレス）
   - Password: 任意のパスワード
4. 「Create user」をクリック

---

## ステップ6: アプリの起動と動作確認

### 6-1. 出店者向けアプリを起動

```bash
cd /Users/mocky700/Desktop/デミセル/store
npm run dev
```

ブラウザで http://localhost:3001 にアクセス

### 6-2. 主催者向けアプリを起動（別のターミナル）

```bash
cd /Users/mocky700/Desktop/デミセル/organizer
npm run dev
```

ブラウザで http://localhost:3002 にアクセス

### 6-3. 管理者向けアプリを起動（別のターミナル）

```bash
cd /Users/mocky700/Desktop/デミセル/admin
npm run dev
```

ブラウザで http://localhost:3003 にアクセス

---

## トラブルシューティング

### エラー: "Missing Supabase environment variables"

→ `.env.local`ファイルが正しい場所にあるか確認
→ ファイル名が`.env.local`であることを確認（`.env`ではない）
→ サーバーを再起動

### Supabaseに接続できない

→ Project URLとAnon Keyが正しいか確認
→ Supabaseプロジェクトが起動しているか確認

### LINE Loginが動作しない

→ Channel IDが正しいか確認
→ Callback URLが正しく設定されているか確認
→ LINE Loginは開発中はスキップして、メール認証を使用可能

### 管理者ログインができない

→ メールアドレスが`NEXT_PUBLIC_ADMIN_EMAILS`に含まれているか確認
→ Supabaseでユーザーが作成されているか確認

---

## チェックリスト

- [ ] Supabaseプロジェクトを作成
- [ ] Supabase APIキーを取得
- [ ] データベーステーブルを作成（5つ）
- [ ] Storageバケットを作成（2つ）
- [ ] LINE Loginチャネルを作成（オプション）
- [ ] OpenAI API Keyを取得（オプション）
- [ ] store/.env.local を作成
- [ ] organizer/.env.local を作成
- [ ] admin/.env.local を作成
- [ ] 管理者ユーザーを作成
- [ ] 3つのアプリが起動することを確認

---

## まとめ

すべての設定が完了したら、3つのアプリが以下のポートで動作します：

- **出店者向けアプリ**: http://localhost:3001
- **主催者向けアプリ**: http://localhost:3002
- **管理者向けアプリ**: http://localhost:3003

問題が発生した場合は、エラーメッセージとともに質問してください。

